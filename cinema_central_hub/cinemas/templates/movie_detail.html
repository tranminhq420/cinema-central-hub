{% extends 'base.html' %}
{% load static %}

{% block title %}{{ film.title }} - Cinema Central Hub{% endblock %}

{% block content %}
<div class="movie-detail">
    <!-- Hero Section -->
    <div class="movie-detail-hero">
        {% if film.image_url %}
        <img src="{{ film.image_url }}" alt="{{ film.title }}" class="movie-backdrop">
        {% endif %}
        <div class="movie-backdrop-overlay"></div>
        
        <div class="container">
            <div class="movie-detail-content">
                <div class="movie-poster-wrap">
                    {% if film.image_url %}
                    <img src="{{ film.image_url }}" alt="{{ film.title }}">
                    {% endif %}
                </div>
                
                <div class="movie-info">
                    <h1 class="movie-title-large">{{ film.title }}</h1>
                    
                    <div class="movie-meta-tags">
                        {% if film.age_limit %}
                        <span class="meta-tag age">{{ film.age_limit }}</span>
                        {% endif %}
                        
                        {% if film.genre %}
                        <span class="meta-tag genre">{{ film.genre }}</span>
                        {% endif %}
                        
                        {% if film.movie_type %}
                        <span class="meta-tag">{{ film.movie_type }}</span>
                        {% endif %}
                        
                        {% if film.format %}
                        <span class="meta-tag format">{{ film.format }}</span>
                        {% endif %}
                    </div>
                    
                    {% if film.description %}
                    <div class="movie-description">
                        {{ film.description }}
                    </div>
                    {% endif %}
                    
                    {% if film.price %}
                    <div class="movie-price-large">
                        Gi√° v√©: {{ film.price }}
                    </div>
                    {% endif %}
                    
                    <div class="movie-actions">
                        {% if film.booking_url %}
                        <a href="{{ film.booking_url }}" target="_blank" class="action-button primary">
                            <i class="fas fa-ticket-alt"></i>
                            ƒê·∫∑t v√© ngay
                        </a>
                        {% endif %}
                        <a href="{% url 'films' %}" class="action-button secondary">
                            <i class="fas fa-arrow-left"></i>
                            Quay l·∫°i
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Showtimes Section -->
    <div class="container">
        <div class="showtimes-section">
            <div class="section-title-wrap">
                <h2 class="section-title">
                    <i class="fas fa-clock"></i>
                    L·ªãch chi·∫øu
                </h2>
                <div class="total-shows">
                    {{ total_screenings }} su·∫•t chi·∫øu
                </div>
            </div>

            {% if theaters %}
            {% for theater_name, screenings in theaters.items %}
            <div class="theater-card">
                <div class="theater-header">
                    <div class="theater-info">
                        <h3 class="theater-name">{{ theater_name }}</h3>
                        <div class="theater-distance">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>C√°ch ƒë√¢y 3km</span>
                        </div>
                    </div>
                </div>
                
                <div class="showtime-grid">
                    {% for screening in screenings %}
                    <div class="showtime-card">
                        <div class="showtime-time">{{ screening.time|time:"H:i" }}</div>
                        <div class="showtime-date">
                            {% if screening.proper_date %}
                            {{ screening.proper_date|date:"l, d/m/Y" }}
                            {% else %}
                            {{ screening.date }}
                            {% endif %}
                        </div>
                        
                        <div class="showtime-tags">
                            {% if screening.format %}
                            <span class="showtime-tag">{{ screening.format }}</span>
                            {% endif %}
                            
                            {% if screening.language %}
                            <span class="showtime-tag language">{{ screening.language }}</span>
                            {% endif %}
                            
                            {% if screening.firstclass == 'True' %}
                            <span class="showtime-tag firstclass">First Class</span>
                            {% endif %}
                        </div>
                        
                        <div class="showtime-actions">
                            <a href="{{ film.booking_url }}" target="_blank" class="showtime-button book">
                                ƒê·∫∑t v√©
                            </a>
                            
                            {% if user.is_authenticated %}
                            {% if screening.is_saved %}
                            <button onclick="removeFromMyShows({{ screening.id }})" 
                                    class="showtime-button saved"
                                    id="btn-{{ screening.id }}">
                                ‚úì
                            </button>
                            {% else %}
                            <button onclick="addToMyShows({{ screening.id }})" 
                                    class="showtime-button save"
                                    id="btn-{{ screening.id }}">
                                +
                            </button>
                            {% endif %}
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
            {% else %}
            <div class="text-center" style="padding: var(--spacing-xl) 0;">
                <div style="font-size: 4rem; margin-bottom: var(--spacing-md);">üé¨</div>
                <h3 style="font-size: 1.5rem; color: var(--text-primary); margin-bottom: var(--spacing-md);">
                    Ch∆∞a c√≥ l·ªãch chi·∫øu cho phim n√†y
                </h3>
                <p style="color: var(--text-secondary);">
                    Vui l√≤ng quay l·∫°i sau ho·∫∑c li√™n h·ªá ch√∫ng t√¥i ƒë·ªÉ bi·∫øt th√™m th√¥ng tin.
                </p>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function addToMyShows(screeningId) {
    const csrftoken = getCookie('csrftoken');
    const button = document.getElementById('btn-' + screeningId);
    
    fetch("{% url 'add_to_my_shows' %}", {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken,
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'screening_id=' + screeningId + '&film_slug={{ film_slug }}'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            button.innerHTML = '‚úì';
            button.className = 'showtime-button saved';
            button.onclick = () => removeFromMyShows(screeningId);
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred. Please try again.');
    });
}

function removeFromMyShows(screeningId) {
    const csrftoken = getCookie('csrftoken');
    const button = document.getElementById('btn-' + screeningId);
    
    fetch("{% url 'remove_from_my_shows' %}", {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken,
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'screening_id=' + screeningId
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            button.innerHTML = '+';
            button.className = 'showtime-button save';
            button.onclick = () => addToMyShows(screeningId);
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred. Please try again.');
    });
}
</script>
{% endblock %} 